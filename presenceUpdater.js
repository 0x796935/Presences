"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const mongodb_1 = require("mongodb");
const fs_1 = require("fs");
mongodb_1.connect(`mongodb://${process.env.MONGO_USERNAME}:${process.env.MONGO_PASSWORD}@${process.env.MONGO_IP}:27017`, {
    appname: "PreMiD-PresenceUpdater",
    useUnifiedTopology: true
}).then(run);
async function run(MongoClient) {
    const dbPresences = await MongoClient.db("PreMiD")
        .collection("presences")
        .find()
        .toArray();
    const presenceFolders = fs_1.readdirSync("./").filter((pF) => !pF.startsWith("@") &&
        !pF.startsWith(".") &&
        !pF.startsWith("node_modules") &&
        fs_1.statSync(pF).isDirectory());
    const presences = presenceFolders.map((pF) => {
        const metadata = JSON.parse(fs_1.readFileSync(`${pF}/dist/metadata.json`, "utf-8")), presenceJs = fs_1.readFileSync(`${pF}/dist/presence.js`, "utf-8");
        let resJson = {
            name: metadata.service,
            url: `https://api.premid.app/v2/presences/${encodeURI(metadata.service)}/`,
            metadata,
            presenceJs
        };
        if (metadata.iframe)
            resJson.iframeJs = fs_1.readFileSync(`${pF}/dist/iframe.js`, "utf-8");
        return resJson;
    });
    const newPresences = presences.filter((p) => !dbPresences.some((dP) => dP.name === p.name)), deletedPresences = dbPresences.filter((dP) => !presences.some((p) => p.name === dP.name)), outdatedPresences = dbPresences
        .filter((p) => presences.find((dp) => p.name === dp.name && dp.metadata.version !== p.metadata.version))
        .map((dP) => presences.find((p) => p.name === dP.name));
    let nP, dP = [], oP = [];
    if (newPresences.length > 0)
        nP = MongoClient.db("PreMiD")
            .collection("presences")
            .insertMany(newPresences);
    if (deletedPresences.length > 0)
        dP = deletedPresences.map((p) => MongoClient.db("PreMiD")
            .collection("presences")
            .deleteOne({ name: p.name }));
    if (outdatedPresences.length > 0)
        oP = outdatedPresences.map((p) => MongoClient.db("PreMiD")
            .collection("presences")
            .findOneAndUpdate({ name: p.metadata.service }, { $set: p }));
    Promise.all([nP, ...dP, ...oP]).then(() => MongoClient.close());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlc2VuY2VVcGRhdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJlc2VuY2VVcGRhdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXFDO0FBQ3JDLHFDQUErQztBQUMvQywyQkFBeUQ7QUFFekQsaUJBQU8sQ0FDTCxhQUFhLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxRQUFRLEVBQ3JHO0lBQ0UsT0FBTyxFQUFFLHdCQUF3QjtJQUNqQyxrQkFBa0IsRUFBRSxJQUFJO0NBQ3pCLENBQ0YsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFFWixLQUFLLFVBQVUsR0FBRyxDQUFDLFdBQXdCO0lBQ3pDLE1BQU0sV0FBVyxHQUFHLE1BQU0sV0FBVyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUM7U0FDL0MsVUFBVSxDQUFDLFdBQVcsQ0FBQztTQUN2QixJQUFJLEVBQUU7U0FDTixPQUFPLEVBQUUsQ0FBQztJQUViLE1BQU0sZUFBZSxHQUFHLGdCQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUM5QyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQ0wsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztRQUNuQixDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1FBQ25CLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7UUFDOUIsYUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUM3QixDQUFDO0lBRUYsTUFBTSxTQUFTLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFO1FBQzNDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQ3ZCLGlCQUFZLENBQUMsR0FBRyxFQUFFLHFCQUFxQixFQUFFLE9BQU8sQ0FB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